
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isConsultant() {
      // Check for isConsultant flag in user profile, or if user is one of the hardcoded super-admins
      let userData = getUserData(request.auth.uid);
      let isEmailConsultant = request.auth.token.email in ['igorhenriqueramon@gmail.com', 'optarh@gmail.com'];
      return (isSignedIn() && userData.isConsultant == true) || isEmailConsultant;
    }

    function isMemberOfClient(clientId) {
      let userData = getUserData(request.auth.uid);
      return isSignedIn() && userData.clientId == clientId;
    }
    
    function hasProductAccess(productName) {
        let userData = getUserData(request.auth.uid);
        return productName in userData.products;
    }
    
    function canAccessProcessFlow(clientId) {
      return isMemberOfClient(clientId) && hasProductAccess('process_flow');
    }

    function canAccessPulseCheck(clientId) {
      return isMemberOfClient(clientId) && hasProductAccess('pulse_check');
    }
    
    function isQuestionGlobal() {
      // A question is global if it has no clientId field or it is null.
      return !('clientId' in resource.data) || resource.data.clientId == null;
    }
    
    function isQuestionForClient(clientId) {
       return resource.data.clientId == clientId;
    }

    // --- Collection Rules ---

    match /users/{userId} {
      allow read: if isOwner(userId) || isConsultant();
      allow write: if isConsultant(); // Only consultants can create/edit user roles.
    }
    
    match /clients/{clientId} {
      allow create: if isConsultant();
      allow read, update: if isConsultant() || isMemberOfClient(clientId);
      allow delete: if false; // Deletion of clients is disallowed.

      // Subcollections for ProcessFlow
      match /activities/{activityId} {
        allow read, write: if isConsultant() || canAccessProcessFlow(clientId);
      }
      
      // Subcollections for PulseCheck
      match /surveys/{surveyId} {
        // Consultants can manage all surveys, client members can only read them
        allow read: if isConsultant() || canAccessPulseCheck(clientId);
        allow write: if isConsultant() || canAccessPulseCheck(clientId);
      }
      
      // Subcollection for Consultancy Actions
      match /actions/{consultancyActionId} {
        allow read, write: if isConsultant();
      }
    }
    
    // --- PulseCheck Specific Collections ---
    
    match /pulse_check_questions/{questionId} {
      // Allow reading a question if it's global OR if the user is a consultant.
      // Non-consultant users can only read questions for their own client if they have PulseCheck access.
      allow get: if isSignedIn() && (isQuestionGlobal() || isConsultant() || (isQuestionForClient(getUserData(request.auth.uid).clientId) && hasProductAccess('pulse_check')));
      allow list: if isConsultant() || (
        isSignedIn() && hasProductAccess('pulse_check')
      );
      
      // Only consultants can create, update, or delete question templates.
      allow write: if isConsultant();
    }
    
    match /pulse_check_responses/{responseId} {
       // Allow anyone to submit a response. This supports anonymous submissions.
       allow create: if true; 
       // Consultants can read all responses.
       // Client members can read responses for their own client ID if they have pulse_check access.
       allow read: if isConsultant() || canAccessPulseCheck(resource.data.clientId);
       // Consultants can delete responses, but no one can update them.
       allow update: if false;
       allow delete: if isConsultant() || (
         isSignedIn() &&
         getUserData(request.auth.uid).clientId == resource.data.clientId &&
         hasProductAccess('pulse_check')
       );
    }
  }
}
