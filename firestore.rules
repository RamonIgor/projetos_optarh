
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isConsultant() {
      // Check for isConsultant flag in user profile, or if user is one of the hardcoded super-admins
      let userData = getUserData(request.auth.uid);
      let isEmailConsultant = request.auth.token.email in ['igorhenriqueramon@gmail.com', 'optarh@gmail.com'];
      return (isSignedIn() && userData.isConsultant == true) || isEmailConsultant;
    }

    function isMemberOfClient(clientId) {
      let userData = getUserData(request.auth.uid);
      return isSignedIn() && userData.clientId == clientId;
    }
    
    function hasProductAccess(productName) {
        let userData = getUserData(request.auth.uid);
        return productName in userData.products;
    }
    
    function canAccessProcessFlow(clientId) {
      return isMemberOfClient(clientId) && hasProductAccess('process_flow');
    }

    function canAccessPulseCheck(clientId) {
      return isMemberOfClient(clientId) && hasProductAccess('pulse_check');
    }

    // --- Collection Rules ---

    match /users/{userId} {
      allow read: if isOwner(userId) || isConsultant();
      allow write: if isConsultant(); // Only consultants can create/edit user roles.
    }
    
    match /clients/{clientId} {
      allow create: if isConsultant();
      allow read, update: if isConsultant() || isMemberOfClient(clientId);
      allow delete: if false; // Deletion of clients is disallowed.

      // Subcollections for ProcessFlow
      match /activities/{activityId} {
        allow read, write: if isConsultant() || canAccessProcessFlow(clientId);
      }
      
      // Subcollections for PulseCheck
      match /surveys/{surveyId} {
        // Consultants can manage all surveys, client members can only read them
        allow read: if isConsultant() || canAccessPulseCheck(clientId);
        allow write: if isConsultant();
      }
      
      // Subcollection for Consultancy Actions
      match /actions/{consultancyActionId} {
        allow read, write: if isConsultant();
      }
    }
    
    // --- PulseCheck Specific Collections ---
    
    match /pulse_check_questions/{questionId} {
      // Questions are global templates managed only by consultants
      allow read: if isSignedIn(); // Any signed-in user can read question templates
      allow write: if isConsultant();
    }
    
    match /pulse_check_responses/{responseId} {
       // Allow anyone to submit a response. This supports anonymous submissions.
       allow create: if true; 
       // Consultants can read all responses.
       // Client members can read responses for their own client ID if they have pulse_check access.
       allow read: if isConsultant() || (
         isSignedIn() &&
         resource.data.clientId == getUserData(request.auth.uid).clientId &&
         hasProductAccess('pulse_check')
       );
       // Nobody can update or delete responses once submitted.
       allow update, delete: if false;
    }
  }
}
