
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isConsultant() {
      let userData = getUserData(request.auth.uid);
      let isEmailConsultant = request.auth.token.email in ['igorhenriqueramon@gmail.com', 'optarh@gmail.com'];
      return (isSignedIn() && userData.isConsultant == true) || isEmailConsultant;
    }

    function isMemberOfClient(clientId) {
      let userData = getUserData(request.auth.uid);
      return isSignedIn() && userData.clientId == clientId;
    }
    
    function hasProductAccess(productName) {
        let userData = getUserData(request.auth.uid);
        return productName in userData.products;
    }
    
    function canAccessProcessFlow(clientId) {
      return isMemberOfClient(clientId) && hasProductAccess('process_flow');
    }

    // --- Collection Rules ---

    match /users/{userId} {
      allow read: if isOwner(userId) || isConsultant();
      allow write: if isConsultant(); // Only consultants can create/edit user roles.
    }
    
    match /clients/{clientId} {
      allow create: if isConsultant();
      allow read, update: if isConsultant() || isMemberOfClient(clientId);
      allow delete: if false; // Deletion of clients is disallowed.

      // Subcollections for ProcessFlow
      match /activities/{activityId} {
        allow read, write: if isConsultant() || canAccessProcessFlow(clientId);
      }
      
      match /actions/{actionId} {
        allow read: if isConsultant() || canAccessProcessFlow(clientId);
        allow write: if isConsultant(); // Only consultants can create/edit actions.
      }
    }

    // --- Deprecated Collections (for migration if needed) ---
    match /activities/{activityId} {
      allow read, write, delete: if isConsultant();
    }
    match /consultancy-actions/{actionId} {
       allow read, write, delete: if isConsultant();
    }
    match /rh-dp-activities/{activityId} {
       allow read, write, delete: if isConsultant();
    }
  }
}
