rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    function isConsultant() {
      // Check for role in the users collection OR if the user email is in the admin list.
      let isRoleConsultant = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'consultant';
      let isEmailConsultant = request.auth.token.email in ['igorhenriqueramon@gmail.com', 'optarh@gmail.com'];
      return isRoleConsultant || isEmailConsultant;
    }

    function isClientMember(clientId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return userDoc.clientId == clientId && userDoc.role == 'client_user';
    }

    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isConsultant());
      allow write: if request.auth != null && isConsultant();
    }

    match /clients/{clientId} {
      // Consultants can create clients.
      // Members of a client or consultants can read/update their own client doc.
      allow create: if request.auth != null && isConsultant();
      allow read, update: if request.auth != null && (isClientMember(clientId) || isConsultant());
      
      // Deletion of clients is disallowed for now.
      allow delete: if false;

      match /activities/{activityId} {
        allow read, write: if request.auth != null && (isClientMember(clientId) || isConsultant());
      }
      
      match /actions/{actionId} {
        allow read: if request.auth != null && (isClientMember(clientId) || isConsultant());
        allow write: if request.auth != null && isConsultant();
      }
    }
  }
}
